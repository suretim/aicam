# 使用官方TensorFlow GPU镜像
FROM tensorflow/tensorflow:2.13.0-gpu-jupyter

# 解决国内拉镜像慢的问题（可选）
# RUN sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list

# 安装conda并创建环境
RUN apt-get update && \
    apt-get install -y wget && \
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ~/miniconda.sh && \
    bash ~/miniconda.sh -b -p /opt/conda && \
    rm ~/miniconda.sh

# 设置环境变量
ENV PATH /opt/conda/bin:$PATH

# 创建并激活conda环境
RUN conda create -n myenv python=3.10 -y && \
    echo "conda activate myenv" >> ~/.bashrc

# 安装核心包（使用conda优先）
RUN conda install -n myenv -c conda-forge \
    numpy=1.24.0 \
    pandas=1.5.3 \
    jupyterlab=3.6.3 \
    ipykernel=6.22.0 \
    cudatoolkit=11.8.0 \
    cudnn=8.6.0 && \
    /opt/conda/envs/myenv/bin/pip install \
    tensorflow==2.13.0 \
    tensorflow-hub==0.13.0 \
    flwr==1.8.0

# 配置Jupyter内核
RUN /opt/conda/envs/myenv/bin/python -m ipykernel install --name=myenv --display-name "Python (myenv)"

# 开放端口和启动命令
EXPOSE 8888
CMD ["sh", "-c", "jupyter lab --ip=0.0.0.0 --no-browser --allow-root"]